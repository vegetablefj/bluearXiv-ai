# .github/workflows/arxiv-daily-pipeline.yml
name: arXiv Daily Paper Pipeline

on:
  schedule:
    - cron: '0 4 * * *'  # UTC时间4点 = 北京时间12点
  workflow_dispatch:
    inputs:
      skip_fetch:
        description: '跳过抓取步骤'
        required: false
        default: 'false'
      test_mode:
        description: '测试模式'
        required: false
        default: 'false'

env:
  PYTHON_VERSION: '3.10'

jobs:
  process-papers:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install requests beautifulsoup4 openai
        
#    - name: Install minimal LaTeX (允许失败)
#      continue-on-error: true
#      run: |
#        echo "安装最小化LaTeX环境..."
#        sudo apt-get update
#        sudo apt-get install -y \
#          texlive-xetex \
#          texlive-latex-recommended \
#          latexmk \
#          texlive-lang-chinese \
#          fonts-noto-cjk-extra || echo "LaTeX安装有错误，但继续执行"
        
#    - name: Fix Python script imports
#      run: |
#        # 检查并修复xelatex_compile.py中的导入
#        if grep -q "re\." scripts/xelatex_compile.py && ! grep -q "^import re" scripts/xelatex_compile.py; then
#          echo "修复re模块导入..."
#          sed -i '1s/^/import re\n/' scripts/xelatex_compile.py
#        fi
        
    - name: Create directories
      run: |
        mkdir -p data/raw log config
    
    - name: Run pipeline (允许部分失败)
      continue-on-error: true
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        MODEL_SCOPE_API_KEY: ${{ secrets.MODEL_SCOPE_API_KEY }}
      run: |
        set +e  # 允许错误继续执行
        
        echo "=== Starting arXiv Pipeline ==="
        
        # 抓取论文（可选跳过）
        if [ "${{ github.event.inputs.skip_fetch }}" != "true" ]; then
          echo "步骤1: 抓取论文ID"
          cd scripts && python fetch_paper_ids.py || echo "抓取步骤有错误，但继续执行" && cd ..
        else
          echo "步骤1: 跳过抓取（使用现有数据）"
        fi
        
        # AI反馈
        echo "步骤2: 生成AI反馈"
        cd scripts
        if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
          python ai_feedback.py --test-mode || echo "AI反馈步骤有错误，但继续执行"
        else
          python ai_feedback.py || echo "AI反馈步骤有错误，但继续执行"
        fi
        cd ..
        
        # 分类过滤
        echo "步骤3: 运行分类过滤"
        cd scripts && python category_filter.py || echo "分类过滤步骤有错误，但继续执行" && cd ..
        
        # 生成TeX
        echo "步骤4: 生成TeX文件"
        cd scripts && python generate_tex.py || echo "生成TeX步骤有错误，但继续执行" && cd ..
        
#        # 编译PDF（允许失败）
#        echo "步骤5: 编译PDF"
#        cd scripts && python xelatex_compile.py --use-latexmk --verbose || echo "PDF编译失败，但继续执行" && cd ..
        
        echo "=== Pipeline Complete ==="
    
    - name: Check what files were generated
      if: always()
      run: |
        echo "=== 生成的文件检查 ==="
        echo "当前目录:"
        pwd
        ls -la
        
        echo "检查TeX文件:"
        if [ -f "latest.tex" ]; then
          echo "✓ latest.tex 存在"
          tex_size=$(stat -c%s latest.tex 2>/dev/null || echo "unknown")
          echo "TeX文件大小: $tex_size 字节"
          echo "前10行内容:"
          head -10 latest.tex
        else
          echo "✗ latest.tex 不存在"
        fi
        
#        echo "检查PDF文件:"
#        if [ -f "latest.pdf" ]; then
#          echo "✓ latest.pdf 存在"
#          pdf_size=$(stat -c%s latest.pdf 2>/dev/null || echo "unknown")
#          echo "PDF文件大小: $pdf_size 字节"
#        else
#          echo "✗ latest.pdf 不存在"
#        fi
        
        echo "检查数据目录:"
        if [ -d "data" ]; then
          echo "✓ data目录存在"
          find data/ -type f -name "*.json" | head -5
        else
          echo "✗ data目录不存在"
        fi
        
#        echo "检查日志目录:"
#        if [ -d "log" ]; then
#          echo "✓ log目录存在"
#          ls -la log/ || echo "无法列出日志目录"
#        else
#          echo "✗ log目录不存在"
#        fi
    
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: arxiv-daily-$(date +%Y-%m-%d)
        path: |
#          latest.pdf
          latest.tex
          data/
#          log/
        retention-days: 7
    
    - name: Commit generated files
      if: always()
      run: |
        # 配置Git
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        echo "=== 准备提交生成的文件 ==="
        
        # 只添加实际存在的文件
        FILES_TO_COMMIT=""
        
#        if [ -f "latest.pdf" ]; then
#          git add latest.pdf
#          FILES_TO_COMMIT="$FILES_TO_COMMIT latest.pdf"
#          echo "✓ 添加 latest.pdf"
#        else
#          echo "⚠ 跳过 latest.pdf (文件不存在)"
#        fi
        
        if [ -f "latest.tex" ]; then
          git add latest.tex
          FILES_TO_COMMIT="$FILES_TO_COMMIT latest.tex"
          echo "✓ 添加 latest.tex"
        else
          echo "⚠ 跳过 latest.tex (文件不存在)"
        fi
        
        if [ -d "data" ]; then
          git add data/
          FILES_TO_COMMIT="$FILES_TO_COMMIT data/"
          echo "✓ 添加 data/ 目录"
        else
          echo "⚠ 跳过 data/ (目录不存在)"
        fi
        
        if [ -d "log" ]; then
          git add log/
          FILES_TO_COMMIT="$FILES_TO_COMMIT log/"
          echo "✓ 添加 log/ 目录"
        else
          echo "⚠ 跳过 log/ (目录不存在)"
        fi
        
        # 检查是否有文件要提交
        if [ -z "$FILES_TO_COMMIT" ]; then
          echo "❌ 没有文件可提交"
          exit 0
        fi
        
        # 检查是否有更改
        if git diff --cached --quiet; then
          echo "没有文件更改，跳过提交"
        else
          # 提交更改
          COMMIT_MSG="自动生成: arXiv日报 $(date +%Y-%m-%d)"
          
#          # 检查是否有错误
#          if [ -f "log/xelatex_compile.log" ] && grep -q "❌" log/xelatex_compile.log; then
#            COMMIT_MSG="$COMMIT_MSG [包含错误]"
#          fi
          
          git commit -m "$COMMIT_MSG"
          
          # 推送到仓库
          echo "推送更改到仓库..."
          git push || echo "推送失败，但继续执行"
          
          echo "✓ 文件已提交到仓库: $FILES_TO_COMMIT"
        fi
    
    - name: Create workflow summary
      if: always()
      run: |
        echo "## arXiv Daily Paper Pipeline Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**执行时间:** $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # 检查生成的文件
        if [ -f "latest.pdf" ]; then
          pdf_size=$(stat -c%s latest.pdf 2>/dev/null || echo "unknown")
          echo "✅ **PDF生成成功**" >> $GITHUB_STEP_SUMMARY
          echo "- 文件: latest.pdf" >> $GITHUB_STEP_SUMMARY
          echo "- 大小: $pdf_size 字节" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **PDF生成失败**" >> $GITHUB_STEP_SUMMARY
          echo "- 未生成PDF文件" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "latest.tex" ]; then
          tex_size=$(stat -c%s latest.tex 2>/dev/null || echo "unknown")
          echo "✅ **TeX文件生成成功**" >> $GITHUB_STEP_SUMMARY
          echo "- 文件: latest.tex" >> $GITHUB_STEP_SUMMARY
          echo "- 大小: $tex_size 字节" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **TeX文件生成失败**" >> $GITHUB_STEP_SUMMARY
          echo "- 未生成TeX文件" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**工作流状态:**" >> $GITHUB_STEP_SUMMARY
        echo "- 总体结果: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- 生成的文件已提交到仓库" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*此报告由GitHub Actions自动生成*" >> $GITHUB_STEP_SUMMARY
