# .github/workflows/arxiv-daily-pipeline.yml
name: arXiv Daily Paper Pipeline

on:
  schedule:
    - cron: '0 4 * * *'  # UTC时间4点 = 北京时间12点
  workflow_dispatch:
    inputs:
      skip_fetch:
        description: '跳过抓取步骤'
        required: false
        default: 'false'
      test_mode:
        description: '测试模式'
        required: false
        default: 'false'

env:
  PYTHON_VERSION: '3.10'

jobs:
  process-papers:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install requests beautifulsoup4 openai
        
    - name: Install LaTeX with full Chinese support
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          texlive-full \  # 安装完整TeX Live（包含所有包）
          latexmk
        # 或者使用更轻量的安装（如果texlive-full太大）
        # sudo apt-get install -y \
        #   texlive-xetex \
        #   texlive-latex-extra \
        #   texlive-fonts-extra \
        #   texlive-science \
        #   texlive-lang-chinese \
        #   texlive-lang-japanese \
        #   latexmk \
        #   fonts-noto-cjk
    
    - name: Fix Python script imports
      run: |
        # 检查并修复xelatex_compile.py中的导入
        if grep -q "re\." scripts/xelatex_compile.py && ! grep -q "^import re" scripts/xelatex_compile.py; then
          echo "修复re模块导入..."
          sed -i '1s/^/import re\n/' scripts/xelatex_compile.py
        fi
        
    - name: Create directories
      run: |
        mkdir -p data/raw log config
    
    - name: Run pipeline
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        MODEL_SCOPE_API_KEY: ${{ secrets.MODEL_SCOPE_API_KEY }}
      run: |
        set -e  # 遇到错误立即退出
        
        echo "=== Starting arXiv Pipeline ==="
        
        # 抓取论文（可选跳过）
        if [ "${{ github.event.inputs.skip_fetch }}" != "true" ]; then
          echo "步骤1: 抓取论文ID"
          cd scripts && python fetch_paper_ids.py && cd ..
        else
          echo "步骤1: 跳过抓取（使用现有数据）"
        fi
        
        # AI反馈
        echo "步骤2: 生成AI反馈"
        cd scripts
        if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
          python ai_feedback.py --test-mode
        else
          python ai_feedback.py
        fi
        cd ..
        
        # 分类过滤
        echo "步骤3: 运行分类过滤"
        cd scripts && python category_filter.py && cd ..
        
        # 生成TeX
        echo "步骤4: 生成TeX文件"
        cd scripts && python generate_tex.py && cd ..
        
        # 编译PDF
        echo "步骤5: 编译PDF"
        cd scripts && python xelatex_compile.py --use-latexmk --verbose && cd ..
        
        echo "=== Pipeline Complete ==="
    
    - name: Check compilation result
      run: |
        if [ -f "latest.pdf" ]; then
          echo "✓ PDF编译成功"
          pdf_size=$(stat -c%s latest.pdf 2>/dev/null || echo "unknown")
          echo "PDF文件大小: $pdf_size 字节"
          # 检查PDF是否有效
          if file latest.pdf | grep -q "PDF document"; then
            echo "✓ PDF文件格式有效"
          else
            echo "⚠ PDF文件可能损坏"
          fi
        else
          echo "✗ PDF编译失败"
          # 检查是否有TeX文件
          if [ -f "latest.tex" ]; then
            echo "✓ TeX文件存在，尝试手动编译..."
            # 尝试直接编译
            xelatex -interaction=nonstopmode latest.tex || true
            if [ -f "latest.pdf" ]; then
              echo "✓ 手动编译成功"
            else
              echo "✗ 手动编译也失败"
            fi
          fi
          exit 1
        fi
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: arxiv-daily-$(date +%Y-%m-%d)
        path: |
          latest.pdf
          latest.tex
          data/
          log/
        retention-days: 7
    
    - name: Commit generated files
      if: success()
      run: |
        # 配置Git
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # 添加生成的文件
        git add latest.pdf latest.tex data/ log/
        
        # 检查是否有更改
        if git diff --staged --quiet; then
          echo "没有文件更改，跳过提交"
        else
          # 提交更改
          git commit -m "自动生成: arXiv日报 $(date +%Y-%m-%d)"
          # 推送到仓库
          git push
          echo "✓ 文件已提交到仓库"
        fi
