# .github/workflows/arxiv-daily-pipeline.yml
name: arXiv Daily Paper Pipeline (TeX Only)

on:
  schedule:
    - cron: '0 4 * * *'  # UTC时间4点 = 北京时间12点
  workflow_dispatch:
    inputs:
      skip_fetch:
        description: '跳过抓取步骤'
        required: false
        default: 'false'
      test_mode:
        description: '测试模式'
        required: false
        default: 'false'

env:
  PYTHON_VERSION: '3.10'

jobs:
  process-papers:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install requests beautifulsoup4 openai
        
    - name: Create directories
      run: |
        mkdir -p data/raw log config
    
    - name: Run pipeline (允许部分失败)
      continue-on-error: true
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        MODEL_SCOPE_API_KEY: ${{ secrets.MODEL_SCOPE_API_KEY }}
      run: |
        set +e  # 允许错误继续执行
        
        echo "=== Starting arXiv Pipeline (TeX Only) ==="
        
        # 抓取论文（可选跳过）
        if [ "${{ github.event.inputs.skip_fetch }}" != "true" ]; then
          echo "步骤1: 抓取论文ID"
          cd scripts && python fetch_paper_ids.py || echo "抓取步骤有错误，但继续执行" && cd ..
        else
          echo "步骤1: 跳过抓取（使用现有数据）"
        fi
        
        # AI反馈
        echo "步骤2: 生成AI反馈"
        cd scripts
        if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
          python ai_feedback.py --test-mode || echo "AI反馈步骤有错误，但继续执行"
        else
          python ai_feedback.py || echo "AI反馈步骤有错误，但继续执行"
        fi
        cd ..
        
        # 分类过滤
        echo "步骤3: 运行分类过滤"
        cd scripts && python category_filter.py || echo "分类过滤步骤有错误，但继续执行" && cd ..
        
        # 生成TeX
        echo "步骤4: 生成TeX文件"
        cd scripts && python generate_tex.py || echo "生成TeX步骤有错误，但继续执行" && cd ..
        
        echo "=== Pipeline Complete (仅生成TeX文件) ==="
    
    - name: Check what files were generated
      if: always()
      run: |
        echo "=== 生成的文件检查 ==="
        echo "当前目录:"
        pwd
        ls -la
        
        echo "检查TeX文件:"
        if [ -f "latest.tex" ]; then
          echo "✓ latest.tex 存在"
          tex_size=$(stat -c%s latest.tex 2>/dev/null || echo "unknown")
          echo "TeX文件大小: $tex_size 字节"
          echo "前10行内容:"
          head -10 latest.tex
        else
          echo "✗ latest.tex 不存在"
        fi
        
        echo "检查数据目录:"
        if [ -d "data" ]; then
          echo "✓ data目录存在"
          find data/ -type f -name "*.json" | head -5
        else
          echo "✗ data目录不存在"
        fi
        
        echo "检查日志目录:"
        if [ -d "log" ]; then
          echo "✓ log目录存在"
          ls -la log/ || echo "无法列出日志目录"
        else
          echo "✗ log目录不存在"
        fi
    
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: arxiv-daily-$(date +%Y-%m-%d)
        path: |
          latest.tex
          data/
          log/  # 仍然上传到artifacts，但不提交到git仓库
        retention-days: 7
    
    - name: Commit generated files
      if: always()
      run: |
        # 配置Git
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        echo "=== 准备提交生成的文件 ==="
        
        # 只添加实际存在的文件（不添加被.gitignore忽略的log目录）
        FILES_TO_COMMIT=""
        
        if [ -f "latest.tex" ]; then
          git add latest.tex
          FILES_TO_COMMIT="$FILES_TO_COMMIT latest.tex"
          echo "✓ 添加 latest.tex"
        else
          echo "⚠ 跳过 latest.tex (文件不存在)"
        fi
        
        if [ -d "data" ]; then
          git add data/
          FILES_TO_COMMIT="$FILES_TO_COMMIT data/"
          echo "✓ 添加 data/ 目录"
        else
          echo "⚠ 跳过 data/ (目录不存在)"
        fi
        
        # 不添加log目录，因为它在.gitignore中
        # 如果您确实需要提交log文件，请取消注释下面的代码并使用git add -f
        # if [ -d "log" ]; then
        #   git add -f log/  # 使用-f强制添加
        #   FILES_TO_COMMIT="$FILES_TO_COMMIT log/"
        #   echo "✓ 强制添加 log/ 目录"
        # else
        #   echo "⚠ 跳过 log/ (目录不存在)"
        # fi
        
        # 检查是否有文件要提交
        if [ -z "$FILES_TO_COMMIT" ]; then
          echo "❌ 没有文件可提交"
          exit 0
        fi
        
        # 检查是否有更改
        if git diff --cached --quiet; then
          echo "没有文件更改，跳过提交"
        else
          # 提交更改
          COMMIT_MSG="自动生成: arXiv日报 $(date +%Y-%m-%d) [仅TeX文件]"
          
          git commit -m "$COMMIT_MSG"
          
          # 推送到仓库
          echo "推送更改到仓库..."
          git push || echo "推送失败，但继续执行"
          
          echo "✓ 文件已提交到仓库: $FILES_TO_COMMIT"
        fi
    
    - name: Create workflow summary
      if: always()
      run: |
        echo "## arXiv Daily Paper Pipeline Report (TeX Only)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**执行时间:** $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "latest.tex" ]; then
          tex_size=$(stat -c%s latest.tex 2>/dev/null || echo "unknown")
          echo "✅ **TeX文件生成成功**" >> $GITHUB_STEP_SUMMARY
          echo "- 文件: latest.tex" >> $GITHUB_STEP_SUMMARY
          echo "- 大小: $tex_size 字节" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **TeX文件生成失败**" >> $GITHUB_STEP_SUMMARY
          echo "- 未生成TeX文件" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**工作流状态:**" >> $GITHUB_STEP_SUMMARY
        echo "- 总体结果: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- 生成的文件已提交到仓库" >> $GITHUB_STEP_SUMMARY
        echo "- 注: 当前仅生成TeX文件，PDF编译已禁用" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*此报告由GitHub Actions自动生成*" >> $GITHUB_STEP_SUMMARY
