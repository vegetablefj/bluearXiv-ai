# .github/workflows/arxiv-daily-pipeline.yml
name: arXiv Daily Paper Pipeline

on:
  schedule:
    - cron: '0 4 * * *'  # 每天UTC时间4点（北京时间12点）
  workflow_dispatch:
    inputs:
      skip_fetch:
        description: '跳过抓取步骤（使用现有数据）'
        required: false
        default: 'false'
      test_mode:
        description: '测试模式（只处理少量论文）'
        required: false
        default: 'false'

env:
  PYTHON_VERSION: '3.10'

jobs:
  process-papers:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 arxiv-py openai
    
    - name: Install LaTeX
      run: |
        sudo apt-get update
        sudo apt-get install -y texlive-xetex texlive-latex-extra latexmk
    
    - name: Test environment
      run: |
        cd scripts
        python test_environment.py
    
    - name: Run pipeline
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        MODEL_SCOPE_API_KEY: ${{ secrets.MODEL_SCOPE_API_KEY }}
      run: |
        # 设置环境变量
        export PYTHONPATH=$PWD
        
        # 按顺序运行所有脚本
        echo "=== Starting arXiv Pipeline ==="
        
        if [ "${{ github.event.inputs.skip_fetch }}" != "true" ]; then
          echo "1. Fetching paper IDs..."
          python scripts/fetch_paper_ids.py
        else
          echo "1. Skipping fetch (using existing data)"
        fi
        
        echo "2. Generating AI feedback..."
        if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
          python scripts/ai_feedback.py --test-mode
        else
          python scripts/ai_feedback.py
        fi
        
        echo "3. Running category filter..."
        python scripts/category_filter.py
        
        echo "4. Generating TeX file..."
        python scripts/generate_tex.py
        
        echo "5. Compiling PDF..."
        python scripts/xelatex_compile.py --use-latexmk
        
        echo "=== Pipeline Complete ==="
    
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: arxiv-daily-results
        path: |
          latest.pdf
          latest.tex
          data/
          log/
        retention-days: 7
